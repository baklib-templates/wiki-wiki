<div class="px-4">
  <div class="w-full max-w-[var(--max-content-width)] mx-auto pt-4 "
		data-controller="toc"
		data-toc-header-selector-value=".js--header"
		data-toc-offset-value="10"
		data-toc-clipboard-success-value="{{ 'snippets.page.copy_success' | t: '链接已复制' }}"
	>
    <section class="mx-auto w-full max-w-xl">
      {% form_tag 'search', data-turbo-frame: 'frame--search-results', data-turbo-action: 'advance' %}
        <div class="relative text-gray-400 rounded-md group focus:text-gray-900 hover:text-gray-500">
          <button type="submit" class="flex absolute inset-y-0 right-0 items-center pr-3 pl-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 group:text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </button>
          <input type="text" autofocus name="{{form.keywords_field_name}}" value="{{ search.keywords | truncate: 10 | escape }}" placeholder="{{ "search.placeholder" | t: "搜索内容" }}" class="block pr-10 pl-3 w-full h-12 bg-white bg-opacity-25 rounded-md transition duration-300 ease-in-out outline-1 focus-visible:outline-primary hover:outline-2 hover:outline-primary-300 sm:text-md focus:bg-opacity-60">
        </div>
      {% endform_tag %}
    </section>

    {% comment %} 使用turbo-frame，可以使光标一直在输入框中 {% endcomment %}
    <turbo-frame id="frame--search-results">
      {% if search.tag %}
        <section>
          <i class="px-2 py-1 rounded" style="background-color: {{ search.tag.color }}">{{ search.tag.name }}</i>
        </section>
      {% endif %}

      {% if search.keywords or search.tag %}
        {% paginate_tag search.pages, as: 'items', per: 20 %}
          {% assign extends_size = search.extends | size %}
          {% assign items_size = items | size %}
          {% assign total_size = extends_size | plus: items_size %}
          {% assign top_5_paths = items | map: 'path' | limit: 5 | join: ',' %}
          <section
            class="flex flex-col flex-1 gap-6 items-start mx-auto w-full max-w-7xl md:flex-row sm:mt-8"
            data-controller="responsive-attr"
            data-responsive-attr-breakpoints-value='{"sm": 640, "md": 768, "lg": 1024, "xl": 1280, "2xl": 1536}'
          >
            <div class="flex-1 order-2 md:order-1">
              <turbo-frame id="frame--search-results">
                {% if total_size > 0 %}
                  <ul class="space-y-3">
                    {% if search.page_number == 1 and extends_size > 0 %}
                      {% for link in search.extends %}
                        <li class="p-3 rounded-lg bg-primary-50 hover:bg-primary-100">
                          <div>
                            <a class="text-lg text-slate-800 search-highlight-block" href="{{ link.url }}" data-turbo-frame="_top">{{ link.link_text }}</a>
                          </div>
                          <div class="-mt-2">
                            <a href="{{ link.url }}" data-turbo-frame="_top" class="text-xs text-gray-500 font-inter">{{ link.url }}</a>
                          </div>
                        </li>
                      {% endfor %}
                    {% endif %}
                    {% for page in items %}
                      <li class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <div class="flex gap-1">
                          <div class="shrink-0 pt-[1px]">
                            <span class="inline-flex justify-center items-center -ml-1 w-5 h-5 text-xs rounded-full bg-primary-100">{{ forloop.index }}</span>
                          </div>
                          <div>
                            <div class="flex-1">
                              <a class="text-lg text-slate-800 search-highlight-block" href="{{ page.url }}" data-turbo-frame="_top">
                                {{ page.highlighted_search_title }}
                              </a>
                            </div>
                            <div class="-mt-2">
                              <a href="{{ page.url }}" data-turbo-frame="_top" class="text-xs text-gray-500 font-inter">{{ page.url }}</a>
                            </div>
                            {% unless page.highlighted_search_content == empty %}
                              <p class="my-3 text-sm line-clamp-3 text-slate-400 search-highlight-block">{{ page.highlighted_search_content }}</p>
                            {% endunless %}
                            <div class="flex justify-between items-center mt-2">
                              <div class="hidden overflow-x-auto text-sm breadcrumbs md:block">
                                {% render 'breadcrumb', breadcrumb: page.breadcrumb %}
                              </div>
                            </div>
                          </div>
                        </div>
                      </li>
                    {% endfor %}
                  </ul>
                  <div class="flex justify-center px-3 my-8">
                    {% render 'paginate', paginate: paginate %}
                  </div>
                  <script>
                    (function(){
                      const firstPage = {{ search.page_number }} === 1;
                      setTimeout(function(){
                        const aiSearchCompletionContainer = document.getElementById('js--ai-search-completion-container');
                        const aiSearchCompletion = document.getElementById('js--ai-search-completion');
                        if(aiSearchCompletionContainer && aiSearchCompletion && firstPage){
                          aiSearchCompletionContainer.classList.remove('hidden');
                          aiSearchCompletion.dataset.aiSearchCompletionMessageValue = "{{ search.keywords | escape_once }}";
                          aiSearchCompletion.dataset.aiSearchCompletionPathsValue = "{{ top_5_paths }}";
                        }else{
                          aiSearchCompletionContainer.classList.add('hidden');
                        }
                      }, 10);
                    })()
                  </script>
                {% else %}
                  <div class="flex flex-col justify-center items-center h-full">
                    {% assign message = "empty.name" | t: '没有搜索到内容' %}
                    {% render 'empty', message: message %}
                    <script>
                    (function(){
                      setTimeout(function(){
                        const aiSearchCompletionContainer = document.getElementById('js--ai-search-completion-container');
                        if (aiSearchCompletionContainer) aiSearchCompletionContainer.classList.add('hidden');
                      }, 10);
                    })()
                  </script>
                  </div>
                {% endif %}
              </turbo-frame>
            </div>

            {% comment %} AI 搜索结果区域 {% endcomment %}
            {% if site.ai_search_enabled? %}
              <div class="hidden flex-grow-0 order-1 w-full md:order-2 md:w-96" id="js--ai-search-completion-container">
                <div
                  class="p-4 rounded bg-primary-50 space-y-2 chat-container"
                  id="js--ai-search-completion"
                  data-controller="ai-search-completion expandable-content"
                  md:data-controller="ai-search-completion"
                  data-ai-search-completion-hidden-class="hidden opacity-0"
                  data-ai-search-completion-messages-value='{"started":"{{ 'ai.started' | t: '正在开始...' }}","reading":"{{ 'ai.reading' | t: '正在阅读内容...' }}","thinking":"{{ 'ai.thinking' | t: '正在思考...' }}"}'
                  data-ai-search-completion-url-value="/-/ai-search-completion"
                  data-ai-search-completion-auto-submit-value="true"
                  data-expandable-content-max-height-value="12rem"
                  data-expandable-content-hidden-class="hidden"
                >
                  <div class="flex gap-1 items-center text-sm">
                    <div class="overflow-hidden w-5 h-5 bg-gradient-to-r rounded-full from-secondary-500 to-primary-600">
                      <img src="{{ "images/ai-search-icon.apng" | asset_url }}">
                    </div>
                    <span>{{ "ai.title" | t: "AI 搜索" }}</span>
                  </div>
                  <div data-expandable-content-target="content" data-ai-search-completion-target="response" class="ai-response prose max-h-48 md:max-h-[50vh] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
                    <!-- 消息将在这里显示 -->
                  </div>
                  <div class="flex justify-between items-center">
                    <div data-ai-search-completion-target="completed" class="hidden p-2 text-sm text-gray-400 opacity-100 transition-opacity duration-300">
                      {{ "ai.completed" | t: "AI 回答完毕." }}
                    </div>
                    <button data-expandable-content-target="expandButton" class="flex hidden gap-1 items-center p-2 text-sm text-gray-400 opacity-100 transition-opacity duration-300">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-4 h-4" fill="currentColor"><path d="M12 19.1642L18.2071 12.9571L16.7929 11.5429L12 16.3358L7.20712 11.5429L5.79291 12.9571L12 19.1642ZM12 13.5143L18.2071 7.30722L16.7929 5.89301L12 10.6859L7.20712 5.89301L5.79291 7.30722L12 13.5143Z"></path></svg>
                      <span>{{ "ai.expand" | t: "展开内容" }}</span>
                    </button>
                    <button data-expandable-content-target="collapseButton" class="flex hidden gap-1 items-center p-2 text-sm text-gray-400 opacity-100 transition-opacity duration-300">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-4 h-4" fill="currentColor"><path d="M12 4.83582L5.79291 11.0429L7.20712 12.4571L12 7.66424L16.7929 12.4571L18.2071 11.0429L12 4.83582ZM12 10.4857L5.79291 16.6928L7.20712 18.107L12 13.3141L16.7929 18.107L18.2071 16.6928L12 10.4857Z"></path></svg>
                      <span>{{ "ai.collapse" | t: "收起内容" }}</span>
                    </button>
                  </div>
                  <div data-ai-search-completion-target="error" class="hidden text-red-500 opacity-100 transition-opacity duration-300"></div>
                </div>
              </div>
            {% endif %}
          </section>
        {% endpaginate_tag %}
        <script>
          document.querySelector('main').classList.add('flex-1');
          document.querySelector('body').classList.remove('items-center', 'justify-center');
        </script>
      {% else %}
        <script>
          document.querySelector('main').classList.remove('flex-1');
          document.querySelector('body').classList.add('items-center', 'justify-center');
        </script>
      {% endif %}
    </turbo-frame>
  </div>
</div>
